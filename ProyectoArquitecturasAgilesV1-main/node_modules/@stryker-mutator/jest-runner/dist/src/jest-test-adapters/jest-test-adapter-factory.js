import { commonTokens, tokens } from '@stryker-mutator/api/plugin';
import semver from 'semver';
import { pluginTokens } from '../plugin-di.js';
import { JestTestAdapter } from './jest-test-adapter.js';
function coerceVersion(version) {
    return { version: semver.coerce(version), raw: version };
}
export function jestTestAdapterFactory(log, jestWrapper, options, injector) {
    const coercedVersion = coerceVersion(jestWrapper.getVersion());
    log.debug('Detected Jest version %s', coercedVersion.raw);
    guardJestVersion(coercedVersion, options, log);
    return injector.injectClass(JestTestAdapter);
}
jestTestAdapterFactory.inject = tokens(commonTokens.logger, pluginTokens.jestWrapper, commonTokens.options, commonTokens.injector);
function guardJestVersion({ version, raw }, options, log) {
    if (semver.satisfies(version, '<22.0.0')) {
        throw new Error(`You need Jest version >= 22.0.0 to use the @stryker-mutator/jest-runner plugin, found ${raw}`);
    }
    else if (semver.satisfies(version, '<24')) {
        if (options.coverageAnalysis !== 'off') {
            throw new Error(`You need Jest version >= 24.0.0 to use the @stryker-mutator/jest-runner with "coverageAnalysis": "${options.coverageAnalysis}", you're currently using version 23.0.0. Please upgrade your jest version, or set "coverageAnalysis": "off".`);
        }
        log.warn('[DEPRECATED] Support for Jest version < 24 is deprecated and will be removed in the next major version of Stryker, please upgrade your jest version (your current version is %s).', raw);
    }
}
//# sourceMappingURL=jest-test-adapter-factory.js.map